# üõ°Ô∏è DOCUMENTACI√ìN T√âCNICA - CAPA DE MIDDLEWARES CYBERHOLE CONDOMINIOS

## üéØ PROP√ìSITO DEL DOCUMENTO
Documentaci√≥n completa de la capa de middlewares del sistema Cyberhole Condominios, que proporciona validaci√≥n de seguridad, autenticaci√≥n, autorizaci√≥n y control de acceso antes de que las solicitudes lleguen a la capa de servicios.

---

## üèóÔ∏è ARQUITECTURA DE MIDDLEWARES

### **üìç Ubicaci√≥n:**
```
üìÇ version2/public_html/middlewares/
‚îú‚îÄ‚îÄ AuthMiddleware.php                 - üîê Autenticaci√≥n
‚îú‚îÄ‚îÄ RoleMiddleware.php                 - üë• Autorizaci√≥n por roles
‚îú‚îÄ‚îÄ CsrfMiddleware.php                 - üõ°Ô∏è Protecci√≥n CSRF
‚îú‚îÄ‚îÄ RateLimitMiddleware.php            - üö¶ Limitaci√≥n de tasa
‚îî‚îÄ‚îÄ CondominioOwnershipMiddleware.php  - üè¢ Propiedad de condominio
```

### **üîÑ Flujo de Middleware:**
```
Solicitud HTTP
    ‚Üì
üîê AuthMiddleware      ‚Üê Verificar sesi√≥n/token
    ‚Üì
üë• RoleMiddleware      ‚Üê Verificar permisos de rol
    ‚Üì
üõ°Ô∏è CsrfMiddleware      ‚Üê Validar token CSRF
    ‚Üì
üö¶ RateLimitMiddleware ‚Üê Controlar frecuencia
    ‚Üì
üè¢ CondominioOwnership ‚Üê Verificar propiedad
    ‚Üì
üìã Servicios/APIs      ‚Üê Procesamiento final
```

---

## üîê 1. AUTHMIDDLEWARE.PHP

### **üéØ Prop√≥sito:**
Verificar que el usuario est√© autenticado mediante sesi√≥n activa o token JWT v√°lido.

### **‚úÖ Funcionalidades:**
- **Verificaci√≥n de sesi√≥n PHP** con expiraci√≥n autom√°tica
- **Validaci√≥n de tokens JWT** con firma HMAC-SHA256
- **Regeneraci√≥n peri√≥dica** de IDs de sesi√≥n
- **Rutas p√∫blicas excluidas** (login, register, health)
- **Manejo de headers Authorization** Bearer token

### **üìã M√©todos Principales:**
```php
// Verificar autenticaci√≥n completa
AuthMiddleware::verify(string $route): array

// Ejecutar y detener si no autorizado
AuthMiddleware::execute(string $route): array

// Verificar sin detener ejecuci√≥n
AuthMiddleware::check(string $route): array

// Cerrar sesi√≥n del usuario
AuthMiddleware::logout(): bool
```

### **üîß Configuraci√≥n:**
```php
// Rutas excluidas de autenticaci√≥n
$excludedRoutes = ['/login', '/register', '/api/auth/*', '/index.php'];

// Tiempo de vida de sesi√≥n (security.php)
'session.lifetime' => 7200, // 2 horas

// Intervalo de regeneraci√≥n de sesi√≥n
'session.regenerate_interval' => 300, // 5 minutos
```

### **üìä Respuestas:**
```php
// √âxito
['success' => true, 'user' => [...]]

// Error
['success' => false, 'error_code' => 401, 'message' => '...']
```

---

## üë• 2. ROLEMIDDLEWARE.PHP

### **üéØ Prop√≥sito:**
Verificar que el usuario tenga el rol adecuado para acceder al recurso solicitado.

### **üè∑Ô∏è Roles del Sistema:**
- **ADMIN** - Acceso completo al sistema
- **RESIDENTE** - Acceso a recursos de residentes
- **EMPLEADO** - Acceso a recursos de empleados

### **üìä Jerarqu√≠a de Roles:**
```php
ADMIN (nivel 3)      ‚Üê Acceso total
    ‚Üì
RESIDENTE (nivel 2)  ‚Üê Acceso intermedio
    ‚Üì  
EMPLEADO (nivel 1)   ‚Üê Acceso b√°sico
```

### **üìã M√©todos Principales:**
```php
// Verificar rol requerido
RoleMiddleware::verify(array $user, $requiredRoles, string $route): array

// Ejecutar y detener si no autorizado
RoleMiddleware::execute(array $user, $requiredRoles, string $route): void

// Verificar sin detener
RoleMiddleware::check(array $user, $requiredRoles, string $route): array

// Verificaciones espec√≠ficas
RoleMiddleware::isAdmin(array $user): bool
RoleMiddleware::isResidente(array $user): bool
RoleMiddleware::isEmpleado(array $user): bool

// Verificar acci√≥n espec√≠fica
RoleMiddleware::canPerformAction(array $user, string $action, string $resource): bool
```

### **üîß Permisos por Ruta:**
```php
'/admin'              => ['ADMIN']
'/api/empleados'      => ['ADMIN', 'EMPLEADO'] 
'/api/personas'       => ['ADMIN', 'RESIDENTE']
'/api/accesos'        => ['ADMIN', 'RESIDENTE', 'EMPLEADO']
```

---

## üõ°Ô∏è 3. CSRFMIDDLEWARE.PHP

### **üéØ Prop√≥sito:**
Proteger contra ataques Cross-Site Request Forgery mediante tokens √∫nicos.

### **üîê Caracter√≠sticas:**
- **Tokens √∫nicos** por sesi√≥n y acci√≥n
- **Expiraci√≥n autom√°tica** (30 minutos por defecto)
- **Regeneraci√≥n opcional** despu√©s del uso
- **M√∫ltiples m√©todos** de env√≠o (POST, headers, JSON)
- **Validaci√≥n de referrer** opcional

### **üìã M√©todos Principales:**
```php
// Generar token CSRF
CsrfMiddleware::generateToken(string $action = 'default'): string

// Verificar token
CsrfMiddleware::verifyToken(string $token, string $action = 'default'): array

// Verificar solicitud HTTP
CsrfMiddleware::verify(string $method, string $route): array

// Ejecutar middleware
CsrfMiddleware::execute(string $method, string $route): void

// Campo HTML para formularios
CsrfMiddleware::field(string $action = 'default'): string

// Token para JavaScript
CsrfMiddleware::getTokenForJS(string $action = 'default'): array

// Meta tag para HTML head
CsrfMiddleware::metaTag(string $action = 'default'): string
```

### **üîß Configuraci√≥n:**
```php
// M√©todos protegidos
$protectedMethods = ['POST', 'PUT', 'PATCH', 'DELETE'];

// Token en formularios
<input type="hidden" name="_token" value="<?= CsrfMiddleware::generateToken() ?>">

// Token en headers AJAX
X-CSRF-TOKEN: token_value

// Token en JSON
{"_token": "token_value", "data": {...}}
```

---

## üö¶ 4. RATELIMITMIDDLEWARE.PHP

### **üéØ Prop√≥sito:**
Limitar la frecuencia de solicitudes para prevenir abusos y ataques DoS.

### **üìä Tipos de L√≠mites:**
- **Login** - 5 intentos en 15 minutos
- **API** - 100 solicitudes en 1 hora  
- **General** - 200 solicitudes en 1 hora

### **üìã M√©todos Principales:**
```php
// Verificar l√≠mite de tasa
RateLimitMiddleware::verify(string $identifier, string $route, string $type): array

// Ejecutar middleware
RateLimitMiddleware::execute(string $identifier, string $route, string $type): void

// Obtener identificador √∫nico
RateLimitMiddleware::getIdentifier(array $user = []): string

// Resetear l√≠mites
RateLimitMiddleware::reset(string $identifier, string $type): bool

// Obtener estad√≠sticas
RateLimitMiddleware::getStats(string $identifier, string $type): array
```

### **üîß Configuraci√≥n:**
```php
// L√≠mites por defecto
'login' => [
    'max_attempts' => 5,
    'window' => 900,        // 15 minutos
    'lockout_time' => 1800  // 30 minutos
],
'api' => [
    'max_attempts' => 100,
    'window' => 3600,       // 1 hora
    'lockout_time' => 3600  // 1 hora
]
```

### **üìç Identificadores:**
- **Usuario logueado:** `user_{id}`
- **Usuario an√≥nimo:** `ip_{direccion_ip}`

---

## üè¢ 5. CONDOMINIOOWNERSHIPMIDDLEWARE.PHP

### **üéØ Prop√≥sito:**
Verificar que los usuarios solo accedan a recursos de su propio condominio.

### **üîí Caracter√≠sticas:**
- **Aislamiento por condominio** - Cada usuario ve solo su condominio
- **Bypass para administradores** - ADMIN ve todos los condominios
- **Verificaci√≥n autom√°tica** por ID de recurso
- **Filtrado de resultados** por propiedad
- **Extracci√≥n autom√°tica** de condominio de solicitudes

### **üìã M√©todos Principales:**
```php
// Verificar propiedad b√°sica
CondominioOwnershipMiddleware::verify(array $user, ?int $condominioId, string $route): array

// Verificar m√∫ltiples condominios
CondominioOwnershipMiddleware::verifyMultiple(array $user, array $condominioIds): array

// Verificar por ID de recurso
CondominioOwnershipMiddleware::verifyByResourceId(array $user, int $resourceId, string $resourceType): array

// Ejecutar middleware
CondominioOwnershipMiddleware::execute(array $user, ?int $condominioId, string $route): void

// Filtrar recursos por propiedad
CondominioOwnershipMiddleware::filterByOwnership(array $user, array $resources): array

// Obtener filtro SQL
CondominioOwnershipMiddleware::getCondominioFilter(array $user, string $condominioField): array
```

### **üìä Rutas Protegidas:**
```php
$protectedRoutes = [
    '/api/empleados',      // Solo empleados del condominio
    '/api/tareas',         // Solo tareas del condominio
    '/api/accesos',        // Solo accesos del condominio
    '/api/personas',       // Solo personas del condominio
    '/api/vehiculos',      // Solo vehicles del condominio
    '/api/calles',         // Solo calles del condominio
    '/api/casas'           // Solo casas del condominio
];
```

---

## üîß IMPLEMENTACI√ìN Y USO

### **üéØ Uso Individual:**
```php
// Autenticaci√≥n
$user = AuthMiddleware::execute($_SERVER['REQUEST_URI']);

// Verificar rol
RoleMiddleware::execute($user, 'ADMIN', $_SERVER['REQUEST_URI']);

// Verificar CSRF
CsrfMiddleware::execute($_SERVER['REQUEST_METHOD'], $_SERVER['REQUEST_URI']);

// Verificar tasa
$identifier = RateLimitMiddleware::getIdentifier($user);
RateLimitMiddleware::execute($identifier, $_SERVER['REQUEST_URI']);

// Verificar condominio
CondominioOwnershipMiddleware::execute($user, $condominioId, $_SERVER['REQUEST_URI']);
```

### **üîÑ Uso en Cadena:**
```php
// Pipeline completo de middlewares
function executeMiddlewarePipeline($route, $method = 'GET', $condominioId = null) {
    // 1. Autenticaci√≥n
    $user = AuthMiddleware::execute($route);
    
    // 2. Limitaci√≥n de tasa
    $identifier = RateLimitMiddleware::getIdentifier($user);
    RateLimitMiddleware::execute($identifier, $route);
    
    // 3. Verificaci√≥n CSRF
    CsrfMiddleware::execute($method, $route);
    
    // 4. Autorizaci√≥n por rol
    RoleMiddleware::execute($user, ['ADMIN', 'RESIDENTE'], $route);
    
    // 5. Propiedad de condominio
    CondominioOwnershipMiddleware::execute($user, $condominioId, $route);
    
    return $user;
}
```

### **üåê Uso en APIs:**
```php
// API endpoint protegido
<?php
require_once 'middlewares/AuthMiddleware.php';
require_once 'middlewares/RoleMiddleware.php';

// Verificar autenticaci√≥n
$authResult = AuthMiddleware::check($_SERVER['REQUEST_URI']);
if (!$authResult['success']) {
    http_response_code(401);
    echo json_encode($authResult);
    exit;
}

// Verificar rol
$roleResult = RoleMiddleware::check($authResult['user'], 'ADMIN');
if (!$roleResult['success']) {
    http_response_code(403);
    echo json_encode($roleResult);
    exit;
}

// Continuar con l√≥gica de API...
```

---

## üîí SEGURIDAD IMPLEMENTADA

### **üõ°Ô∏è Medidas de Protecci√≥n:**
- **Autenticaci√≥n multifactor** (sesi√≥n + JWT)
- **Tokens CSRF √∫nicos** con expiraci√≥n
- **Limitaci√≥n de tasa adaptiva** por usuario/IP
- **Aislamiento de condominios** estricto
- **Validaci√≥n de referrer** opcional
- **Regeneraci√≥n de sesiones** peri√≥dica
- **Logging de errores** completo

### **üîê Configuraci√≥n de Seguridad:**
```php
// config/security.php
'csrf' => [
    'enabled' => true,
    'expire_time' => 1800,     // 30 minutos
    'regenerate_on_use' => true
],
'rate_limiting' => [
    'enabled' => true,
    'login_attempts' => 5,
    'api_requests' => 100
],
'session' => [
    'lifetime' => 7200,        // 2 horas
    'regenerate_interval' => 300  // 5 minutos
]
```

---

## üß™ TESTING Y VALIDACI√ìN

### **‚úÖ Tests Implementados:**
- ‚úÖ **Autenticaci√≥n** - Sesiones v√°lidas/inv√°lidas, tokens JWT
- ‚úÖ **Autorizaci√≥n** - Roles correctos/incorrectos, jerarqu√≠as
- ‚úÖ **CSRF** - Tokens v√°lidos/expirados, m√©todos protegidos
- ‚úÖ **Rate Limiting** - L√≠mites por tipo, bloqueos temporales
- ‚úÖ **Propiedad** - Acceso correcto/cruzado entre condominios

### **üîç Casos de Prueba:**
```php
// Test de autenticaci√≥n
$result = AuthMiddleware::verify('/api/protected');
assert($result['success'] === false); // Sin autenticaci√≥n

// Test de rol
$user = ['type' => 'RESIDENTE'];
$result = RoleMiddleware::verify($user, 'ADMIN');
assert($result['success'] === false); // Rol insuficiente

// Test de CSRF
$result = CsrfMiddleware::verify('POST', '/api/data');
assert($result['success'] === false); // Sin token

// Test de rate limiting
$result = RateLimitMiddleware::verify('ip_127.0.0.1', '/api/login', 'login');
// Verificar l√≠mites
```

---

## üìä M√âTRICAS Y MONITOREO

### **üìà M√©tricas Disponibles:**
- **Intentos de autenticaci√≥n** fallidos/exitosos
- **Violaciones de CSRF** por IP/usuario
- **L√≠mites de tasa excedidos** por tipo
- **Accesos cruzados** entre condominios
- **Tiempo de respuesta** de middlewares

### **üìù Logging:**
```php
// Logs autom√°ticos en todos los middlewares
error_log("AuthMiddleware: Acceso denegado - IP: " . $_SERVER['REMOTE_ADDR']);
error_log("RoleMiddleware: Rol insuficiente - Usuario: " . $user['id']);
error_log("CsrfMiddleware: Token inv√°lido - Sesi√≥n: " . session_id());
```

---

## üöÄ ESTADO ACTUAL

**‚úÖ CAPA DE MIDDLEWARES - 100% FUNCIONAL Y LISTA**

### **üìã Componentes Implementados:**
- ‚úÖ **AuthMiddleware.php** - Autenticaci√≥n completa
- ‚úÖ **RoleMiddleware.php** - Autorizaci√≥n por roles 
- ‚úÖ **CsrfMiddleware.php** - Protecci√≥n CSRF total
- ‚úÖ **RateLimitMiddleware.php** - Limitaci√≥n adaptiva
- ‚úÖ **CondominioOwnershipMiddleware.php** - Aislamiento perfecto

### **üîß Caracter√≠sticas:**
- ‚úÖ **Arquitectura modular** - Cada middleware independiente
- ‚úÖ **Configuraci√≥n centralizada** - Via SecurityConfig
- ‚úÖ **Manejo de errores robusto** - Try/catch en todos
- ‚úÖ **APIs flexibles** - execute() vs check() 
- ‚úÖ **Logging completo** - Para debugging y auditor√≠a
- ‚úÖ **Documentaci√≥n exhaustiva** - Cada m√©todo documentado

### **üéØ Integraci√≥n:**
- ‚úÖ **Compatible con servicios** - Listo para capa superior
- ‚úÖ **Configurable** - Par√°metros en security.php
- ‚úÖ **Testeable** - M√©todos check() para testing
- ‚úÖ **Extensible** - F√°cil agregar nuevos middlewares

---

**üìÖ Creado:** 23 de Julio, 2025  
**üîÑ Versi√≥n:** 1.0.0 - Implementaci√≥n completa  
**‚úÖ Estado:** PRODUCCI√ìN READY - Listo para integraci√≥n con servicios

---

## üîó PR√ìXIMOS PASOS

1. **Integraci√≥n con servicios** - Usar middlewares en capa de servicios
2. **Testing exhaustivo** - Suite de pruebas automatizadas  
3. **Configuraci√≥n production** - Ajustar l√≠mites para producci√≥n
4. **Monitoreo avanzado** - Dashboard de m√©tricas de seguridad
5. **Optimizaci√≥n** - Cache de verificaciones frecuentes
